import sokol_nature.sokol.sokol_app as sapp
import sokol_nature.sokol.sokol_gfx as sg
import sokol_nature.sokol.sokol_glue as sglue
import libc

var pass_action = sg.pass_action_t{}
fn init() {
    var desc = sg.desc_t{}
    desc.environment = sglue.environment()
    sg.setup(&desc)
    pass_action.colors[0].load_action = sg.LOADACTION_CLEAR
    pass_action.colors[0].clear_value = sg.color_t { r: 0.0, g: 0.0, b: 1.0, a: 1.0 }
}

fn frame() {
    var g = pass_action.colors[0].clear_value.g + 0.01
    if g > 1.0 { g = 0 }
    pass_action.colors[0].clear_value.g = g
    var pass = sg.pass_t {action: pass_action, swapchain: sglue.swapchain()}
    sg.begin_pass(&pass)
    sg.end_pass()
    sg.commit()
}

fn cleanup() {
    sg.shutdown()
}

type fn_t = struct{
    anyptr envs
    anyptr addr
}

fn main() {
    var init_cb = fn() {
        var desc = sg.desc_t{}
        desc.environment = sglue.environment()
        sg.setup(&desc)
        pass_action.colors[0].load_action = sg.LOADACTION_CLEAR
        pass_action.colors[0].clear_value = sg.color_t { r: 0.0, g: 0.0, b: 1.0, a: 1.0 }
    }
    var frame_cb = fn() {
        var g = pass_action.colors[0].clear_value.g + 0.01
        if g > 1.0 { g = 0 }
        pass_action.colors[0].clear_value.g = g
        var pass = sg.pass_t {action: pass_action, swapchain: sglue.swapchain()}
        sg.begin_pass(&pass)
        sg.end_pass()
        sg.commit()
    }
    var cleanup_cb = fn() {
        sg.shutdown()
    }
    var ret = sapp.desc_t {
        //init_cb: (init_cb as anyptr as rawptr<fn_t>).addr,
        //frame_cb: (frame_cb as anyptr as rawptr<fn_t>).addr,
        //cleanup_cb: (cleanup_cb as anyptr as rawptr<fn_t>).addr,
        init_cb: libc.to_cfn(init as anyptr),
        frame_cb: libc.to_cfn(frame as anyptr),
        cleanup_cb: libc.to_cfn(cleanup as anyptr),
        //init_cb: init as anyptr,
        //frame_cb: frame as anyptr,
        //cleanup_cb: cleanup as anyptr,
        width: 640,
        height: 480,
        window_title: 'clear'.ref(),
        icon: sapp.icon_desc_t { sokol_default: true },
    }
    sapp.run(&ret)
}

